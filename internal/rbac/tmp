package main

import (
	"encoding/json"
	"fmt"
	"net/http"
	"yourmodule/rbac"

	"github.com/golang-jwt/jwt/v5"
	"github.com/gorilla/mux"
)

var jwtSecret = []byte("supersecret")

func main() {
	svc, err := rbac.NewRBACService(jwtSecret, "rbac/model.conf", "rbac/policy.csv")
	if err != nil {
		panic(err)
	}

	r := mux.NewRouter()

	r.Handle("/delete",
		svc.RequireRoleJWT("Admin")(http.HandlerFunc(DeleteHandler)),
	)

	r.Handle("/judge",
		svc.RequireRoleJWT("Judge")(http.HandlerFunc(JudgeHandler)),
	)

	r.Handle("/read",
		svc.RequireRoleJWT("Spectator")(http.HandlerFunc(ReadHandler)),
	)

	// /permissions endpoint
	r.Handle("/permissions",
		http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			authHeader := r.Header.Get("Authorization")
			if authHeader == "" || len(authHeader) < 7 || authHeader[:7] != "Bearer " {
				http.Error(w, "Missing or invalid token", http.StatusUnauthorized)
				return
			}

			tokenString := authHeader[7:]

			token, err := jwt.Parse(tokenString, func(t *jwt.Token) (interface{}, error) {
				return jwtSecret, nil
			})
			if err != nil || !token.Valid {
				http.Error(w, "Invalid token", http.StatusUnauthorized)
				return
			}

			claims, ok := token.Claims.(jwt.MapClaims)
			if !ok {
				http.Error(w, "Invalid token claims", http.StatusUnauthorized)
				return
			}

			rawRoles, ok := claims["roles"]
			if !ok {
				http.Error(w, "Token missing roles", http.StatusForbidden)
				return
			}

			userRoles := []string{}
			switch v := rawRoles.(type) {
			case []interface{}:
				for _, r := range v {
					if s, ok := r.(string); ok {
						userRoles = append(userRoles, s)
					}
				}
			case string:
				userRoles = []string{v}
			default:
				http.Error(w, "Invalid roles format", http.StatusForbidden)
				return
			}

			effectiveRoles, err := svc.GetEffectiveRoles(userRoles)
			if err != nil {
				http.Error(w, "Error getting roles", http.StatusInternalServerError)
				return
			}

			w.Header().Set("Content-Type", "application/json")
			json.NewEncoder(w).Encode(map[string][]string{
				"roles": effectiveRoles,
			})
		}),
	)

	fmt.Println("Server running on http://localhost:8080")
	http.ListenAndServe(":8080", r)
}

func DeleteHandler(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintln(w, "Deleted successfully!")
}

func JudgeHandler(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintln(w, "Judge action OK")
}

func ReadHandler(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintln(w, "Read OK")
}
